<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Converter</title>
    <script>
      window.addEventListener('load', () => {
        let currentFile;
        const w = localStorage.getItem('width');
        if (w) {
          canvas.width = Number(w);
        }
        width.value = canvas.width;
        const h = localStorage.getItem('height');
        if (h) {
          canvas.height = Number(h);
        }
        height.value = canvas.height;
        width.addEventListener('change', () => {
          canvas.width = Number(width.value);
          localStorage.setItem('width', width.value);
          reload();
        });
        height.addEventListener('change', () => {
          canvas.height = Number(height.value);
          localStorage.setItem('height', height.value);
          reload();
        });
        file.addEventListener('change', () => {
          if (!/\.svg$/i.test(file.files[0].name)) {
            file.value = '';
            return;
          }
          currentFile = file.files[0];
          reload();
        });
        clear.addEventListener('click', () => {
          file.value = '';
          currentFile = undefined;
          reload();
        });
        document.addEventListener(
          'dragover',
          (ev) => {
            ev.preventDefault();
            ev.dataTransfer.dropEffect =
              Array.from(ev.dataTransfer.items).find(
                ({ kind }) => kind === 'file',
              )?.type === 'image/svg+xml'
                ? 'link'
                : 'none';
          },
          false,
        );
        document.addEventListener(
          'drop',
          (ev) => {
            ev.preventDefault();
            for (let i = 0; i < ev.dataTransfer.items.length; ++i) {
              const item = ev.dataTransfer.items[i];
              if (item.kind !== 'file' || item.type !== 'image/svg+xml') {
                continue;
              }
              currentFile = item.getAsFile();
              reload(currentFile);
              break;
            }
          },
          false,
        );
        async function reload() {
          const context = canvas.getContext('2d');
          context.clearRect(0, 0, canvas.width, canvas.height);
          if (!currentFile) {
            download.removeAttribute('href');
            download.removeAttribute('download');
            return;
          }
          const reader = new FileReader();
          reader.readAsDataURL(currentFile);
          await new Promise((resolve) => {
            reader.addEventListener(
              'load',
              () => {
                resolve();
              },
              { once: true },
            );
          });
          const url = reader.result;
          const image = new Image();
          image.src = url;
          await new Promise((resolve) => {
            image.addEventListener(
              'load',
              () => {
                resolve();
              },
              { once: true },
            );
          });
          context.drawImage(image, 0, 0, canvas.width, canvas.height);
          download.href = canvas.toDataURL();
          download.download = `${currentFile.name.match(/^.*(?=\.[^.]+$)/)?.[0] ?? 'image'}.png`;
        }
      });
    </script>
    <style>
      #canvas {
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAANklEQVQ4T2N0cHD4z0AEaGhoIEIVAwPjqIE4w2k0DHEGzRBINgcOHKBuThk1kPKcMhqGgy8MAal4UAF1Mf8eAAAAAElFTkSuQmCC);
      }
      div:has(> #canvas) {
        float: left;
        margin-right: 10px;
      }
      label:has(> input) {
        white-space: nowrap;
      }
    </style>
  </head>
  <div><canvas id="canvas" /></div>
  <div>
    <label>width: <input type="number" id="width" /></label>
    <label>height: <input type="number" id="height" /></label>
  </div>
  <div><input type="file" id="file" /><button id="clear">clear</button></div>
  <a id="download">download</a>
</html>
