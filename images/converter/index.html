<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Converter</title>
    <script>
      // @ts-check
      (async function () {
        await forLoading(window);
        /**
         * @typedef Elements
         * @property {HTMLCanvasElement} canvas
         * @property {HTMLInputElement} width
         * @property {HTMLInputElement} height
         * @property {HTMLInputElement} file
         * @property {HTMLButtonElement} clear
         * @property {HTMLAnchorElement} download
         */
        /**
         * @type {Elements}
         */
        const { canvas, width, height, file, clear, download } = this;
        /** @type {File | undefined | null} */
        let currentFile;
        const w = localStorage.getItem('width');
        if (w) {
          canvas.width = Number(w);
        }
        width.valueAsNumber = canvas.width;
        const h = localStorage.getItem('height');
        if (h) {
          canvas.height = Number(h);
        }
        height.valueAsNumber = canvas.height;
        width.addEventListener('change', () => {
          canvas.width = width.valueAsNumber;
          localStorage.setItem('width', width.value);
          reload();
        });
        height.addEventListener('change', () => {
          canvas.height = height.valueAsNumber;
          localStorage.setItem('height', height.value);
          reload();
        });
        file.addEventListener('change', () => {
          if (!file.files?.length || !/\.svg$/i.test(file.files[0].name)) {
            file.value = '';
            return;
          }
          currentFile = file.files[0];
          reload();
        });
        clear.addEventListener('click', () => {
          file.value = '';
          currentFile = undefined;
          reload();
        });
        document.addEventListener(
          'dragover',
          (ev) => {
            if (!ev.dataTransfer) {
              return;
            }
            ev.preventDefault();
            ev.dataTransfer.dropEffect =
              Array.from(ev.dataTransfer.items).find(
                ({ kind }) => kind === 'file',
              )?.type === 'image/svg+xml'
                ? 'link'
                : 'none';
          },
          false,
        );
        document.addEventListener(
          'drop',
          (ev) => {
            if (!ev.dataTransfer) {
              return;
            }
            ev.preventDefault();
            for (let i = 0; i < ev.dataTransfer.items.length; ++i) {
              const item = ev.dataTransfer.items[i];
              if (item.kind !== 'file' || item.type !== 'image/svg+xml') {
                continue;
              }
              currentFile = item.getAsFile();
              reload();
              break;
            }
          },
          false,
        );
        /**
         * @param {EventTarget} target
         * @returns {Promise<void>}
         */
        function forLoading(target) {
          return new Promise((resolve) => {
            target.addEventListener(
              'load',
              () => {
                resolve();
              },
              { once: true },
            );
          });
        }
        async function reload() {
          const context = canvas.getContext('2d');
          if (!context) {
            return;
          }
          context.clearRect(0, 0, canvas.width, canvas.height);
          if (!currentFile) {
            download.removeAttribute('href');
            download.removeAttribute('download');
            return;
          }
          const reader = new FileReader();
          reader.readAsDataURL(currentFile);
          await forLoading(reader);
          const url = reader.result;
          if (typeof url !== 'string') {
            return;
          }
          const image = new Image();
          image.src = url;
          await forLoading(image);
          context.drawImage(image, 0, 0, canvas.width, canvas.height);
          download.href = canvas.toDataURL();
          download.download = `${/[^/]+(?=\.svg$)/i.exec(currentFile.name)?.[0] ?? 'image'}.png`;
        }
      })();
    </script>
    <style>
      #canvas {
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAANklEQVQ4T2N0cHD4z0AEaGhoIEIVAwPjqIE4w2k0DHEGzRBINgcOHKBuThk1kPKcMhqGgy8MAal4UAF1Mf8eAAAAAElFTkSuQmCC);
      }
      div:has(> #canvas) {
        float: left;
        margin-right: 10px;
      }
      label:has(> input) {
        white-space: nowrap;
      }
    </style>
  </head>
  <div><canvas id="canvas" /></div>
  <div>
    <label>width: <input type="number" id="width" /></label>
    <label>height: <input type="number" id="height" /></label>
  </div>
  <div>
    <input type="file" id="file" accept="=.svg,image/svg+xml" />
    <button id="clear">clear</button>
  </div>
  <a id="download">download</a>
</html>
